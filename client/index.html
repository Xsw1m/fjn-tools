<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å·¥å…·é—¨æˆ· | SUM Aggregator</title>
    <style>
      :root { --primary: #2563eb; --gray:#6b7280; }
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Fira Sans', 'Droid Sans', 'Helvetica Neue', Arial, sans-serif; padding: 24px; background:#fafafa; }
      .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; max-width: 720px; margin: 0 auto; background:white; box-shadow: 0 6px 16px rgba(0,0,0,0.06); }
      h2 { margin: 0 0 8px; }
      p { margin: 0 0 16px; color:#374151; }
      /* é€šç”¨æ³¨é‡Šæ ·å¼ï¼šå°ä¸€å·å­—ä½“ã€ç°è‰² */
      .comment { font-size: 13px; color: var(--gray); margin-top: 8px; }
      label { display:block; font-weight:600; margin-bottom: 6px; }
      .row { display:flex; gap:10px; align-items:center; }
      input[type=text] { flex:1; padding:10px 12px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; }
      input[type=text]:focus { outline:none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,.12); }
      button { padding:10px 14px; border:none; border-radius:8px; background:var(--primary); color:white; cursor:pointer; font-size:14px; transition: transform .06s ease; }
      button:hover { transform: translateY(-1px); }
      button:disabled { opacity:.6; cursor:not-allowed; }
      .status { margin-top:12px; color:#111827; min-height: 20px; }
      .link a { color: var(--primary); text-decoration: none; }
      .link a:hover { text-decoration: underline; }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <div id="app"></div>
    <script type="text/babel">
      const { useState, useEffect } = React;

      // SUM å·¥å…·ç»„ä»¶ï¼ˆåŸæœ‰ UI æŠ½å–ï¼‰
      function SumTool() {
        const [path, setPath] = useState('lots');
        const [showPicker, setShowPicker] = useState(false);
        const [browsePath, setBrowsePath] = useState('lots');
        const [entries, setEntries] = useState([]);
        const [loading, setLoading] = useState(false);
        const [status, setStatus] = useState('');
        const [downloadUrl, setDownloadUrl] = useState('');

        const run = async () => {
          if (!path || !path.trim()) {
            setStatus('è¯·å…ˆå¡«å†™ lots ç›®å½•è·¯å¾„');
            return;
          }
          setLoading(true);
          setStatus('æ­£åœ¨ç”Ÿæˆ xlsx ...');
          setDownloadUrl('');
          try {
            const res = await fetch('/api/sum/run', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ lots_dir: path })
            });
            const data = await res.json();
            if (data.ok) {
              setStatus(`å·²åœ¨æ ¹ç›®å½•ä¸‹çš„ exports æ–‡ä»¶å¤¹ä¸‹æˆåŠŸç”Ÿæˆï¼š${data.filename}`);
              setDownloadUrl(data.download_url);
            } else {
              setStatus('ç”Ÿæˆå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
          } catch (e) {
            setStatus('ç”Ÿæˆå¤±è´¥ï¼š' + e.message);
          } finally {
            setLoading(false);
          }
        };

        const useDefault = () => {
          setPath('lots');
          setStatus('å·²å¡«å……é»˜è®¤ lots è·¯å¾„');
          setDownloadUrl('');
        };

        const loadDir = async (p) => {
          try {
            const res = await fetch(`/api/fs/list?path=${encodeURIComponent(p)}`);
            const data = await res.json();
            if (data.ok) {
              setBrowsePath(data.path);
              setEntries(data.children || []);
            } else {
              setStatus('æµè§ˆå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
          } catch (e) {
            setStatus('æµè§ˆå¤±è´¥ï¼š' + e.message);
          }
        };

        const openPicker = async () => {
          setShowPicker(true);
          setStatus('');
          await loadDir(path);
        };

        const goUp = async () => {
          const slashIdx = browsePath.lastIndexOf('/');
          const backIdx = browsePath.lastIndexOf('\\');
          const idx = Math.max(slashIdx, backIdx);
          if (idx > 0) {
            await loadDir(browsePath.slice(0, idx));
          }
        };

        const chooseCurrent = () => {
          setPath(browsePath);
          setShowPicker(false);
          setStatus('å·²é€‰æ‹©è·¯å¾„');
          setDownloadUrl('');
        };

        return (
          <div className="card">
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
              <h2 style={{margin:0}}>SUM Aggregator</h2>
              <a href="#/" style={{color:'#2563eb',textDecoration:'none'}}>â† è¿”å›é—¨æˆ·</a>
            </div>
            <p className="comment">è¾“å…¥ lots ç›®å½•è·¯å¾„ï¼Œç‚¹å‡»ç”Ÿæˆ xlsxã€‚ä¼šè‡ªåŠ¨é¿å…é‡åï¼ˆå¦‚ result(1).xlsxï¼‰ã€‚</p>
            <label htmlFor="lotsPath">lots è·¯å¾„</label>
            <div className="row">
              <input id="lotsPath" type="text" value={path} onChange={e => setPath(e.target.value)} placeholder="lots" />
              <button onClick={useDefault} disabled={loading} title="å¡«å……é»˜è®¤è·¯å¾„">é»˜è®¤</button>
              <button onClick={openPicker} disabled={loading} title="ä»æœåŠ¡å™¨æµè§ˆå¹¶é€‰æ‹©">é€‰æ‹©</button>
              <button onClick={run} disabled={loading}>ç”Ÿæˆ xlsx</button>
            </div>
            <div className="status">{status}</div>
            {downloadUrl && <div className="link"><a href={downloadUrl} target="_blank" rel="noreferrer">ğŸ¤”æ‰¾ä¸åˆ°ï¼Ÿå¦å­˜ä¸º</a></div>}
            {showPicker && (
              <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,.35)',display:'flex',alignItems:'center',justifyContent:'center'}}>
                <div style={{background:'#fff',borderRadius:12,padding:16,width:'680px',maxHeight:'70vh',boxShadow:'0 10px 30px rgba(0,0,0,.15)'}}>
                  <h3 style={{marginTop:0}}>é€‰æ‹©æœåŠ¡å™¨ç›®å½•</h3>
                  <p style={{color:'#374151',margin:'4px 0 12px'}}>ä»…æµè§ˆé¡¹ç›®æ ¹ç›®å½•å†…çš„è·¯å¾„ã€‚</p>
                  <div style={{display:'flex',gap:8,alignItems:'center',marginBottom:8}}>
                    <input type="text" value={browsePath} readOnly style={{flex:1,padding:'8px 10px',border:'1px solid #d1d5db',borderRadius:8}} />
                    <button onClick={goUp} className="secondary">ä¸Šä¸€çº§</button>
                    <button onClick={chooseCurrent}>é€‰æ‹©å½“å‰è·¯å¾„</button>
                    <button onClick={() => setShowPicker(false)} className="secondary">å…³é—­</button>
                  </div>
                  <div style={{borderTop:'1px solid #eee',paddingTop:8,overflow:'auto',maxHeight:'45vh'}}>
                    {entries.map((it, i) => (
                      <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'6px 0'}}>
                        <span>{it.is_dir ? 'ğŸ“' : 'ğŸ“„'} {it.name}</span>
                        <div style={{display:'flex',gap:8}}>
                          {it.is_dir && (<button className="secondary" onClick={() => loadDir(it.path)}>è¿›å…¥</button>)}
                          {it.is_dir && (<button onClick={() => {setBrowsePath(it.path); setPath(it.path); setShowPicker(false); setStatus('å·²é€‰æ‹©è·¯å¾„'); setDownloadUrl('');}}>é€‰æ‹©</button>)}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      // é—¨æˆ·é¡µé¢ï¼ˆå·¥å…·åˆ—è¡¨ï¼‰
      function Portal() {
        const toolCard = {
          display:'flex',alignItems:'center',gap:16,padding:'14px 16px',border:'1px solid #e5e7eb',borderRadius:12,background:'#fff',
          boxShadow:'0 6px 16px rgba(0,0,0,0.06)',cursor:'pointer',textDecoration:'none',color:'#111827'
        };
        return (
          <div className="card">
            <h2 style={{marginTop:0}}>å·¥å…·é—¨æˆ·</h2>
            <p className="comment">é€‰æ‹©ä¸€ä¸ªå·¥å…·è¿›å…¥ã€‚åç»­å¯ä»¥åœ¨è¿™é‡Œç»§ç»­å¢åŠ æ›´å¤šå°å·¥å…·ã€‚</p>
            <div style={{display:'grid',gridTemplateColumns:'1fr',gap:12}}>
              <a href="#/sum-wizard" style={toolCard} title="SUM å·¥å…·ï¼ˆå‡†å¤‡ + ç”Ÿæˆï¼‰">
                <span style={{fontSize:24}}>ğŸ§­</span>
                <div>
                  <div style={{fontWeight:600}}>SUM å·¥å…·</div>
                  <div style={{color:'#6b7280',fontSize:13}}>å…ˆè¾“å…¥ lot åç­›é€‰å¤åˆ¶ï¼Œå†ç”Ÿæˆ xlsx</div>
                </div>
              </a>
              {/* é¢„ç•™ï¼šæ›´å¤šå·¥å…·å…¥å£å¯ä»¥ç»§ç»­æ·»åŠ  */}
            </div>
          </div>
        );
      }

      // ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ SUM æ–‡ä»¶ï¼ˆè¾“å…¥å¤šä¸ª lot åå¹¶ç­›é€‰å¤åˆ¶ï¼‰
      function PrepareLots() {
        const [sourceRoot, setSourceRoot] = useState('\\\\172.33.10.11\\SLT_Summary');
        const [inputVal, setInputVal] = useState('');
        const [lots, setLots] = useState([]);
        const [status, setStatus] = useState('');
        const [stats, setStats] = useState(null);
        const [preparing, setPreparing] = useState(false);
        const [prepareJobId, setPrepareJobId] = useState('');
        const [progress, setProgress] = useState({ scanned: 0, matched: 0, copied: 0 });
        const addLot = () => {
          const v = (inputVal || '').trim();
          if (!v) return;
          const exists = lots.some(x => x.toLowerCase() === v.toLowerCase());
          if (exists) { setStatus('è¯¥ lot å·²åœ¨åˆ—è¡¨ä¸­'); return; }
          setLots([...lots, v]);
          setInputVal('');
          setStatus('å·²æ·»åŠ ');
        };
        const removeLot = (idx) => {
          const next = lots.slice(); next.splice(idx,1); setLots(next);
        };
        const startPrepare = async () => {
          if (!lots.length) { setStatus('è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€ä¸ª lot å'); return; }
          if (preparing) return;
          setPreparing(true);
          setStatus('æ­£åœ¨ç­›é€‰å¹¶å¤åˆ¶...'); setStats(null);
          try {
            const res = await fetch('/api/sum/prepare/start', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ lot_names: lots, source_root: sourceRoot })
            });
            const data = await res.json();
            if (!data.ok) { setPreparing(false); setStatus('å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯')); return; }
            setPrepareJobId(data.job_id);
            const timer = setInterval(async () => {
              try {
                const r = await fetch(`/api/sum/prepare/status?job=${encodeURIComponent(data.job_id)}`);
                const s = await r.json();
                if (!s.ok) { setStatus('å¤±è´¥ï¼š' + (s.error || 'æœªçŸ¥é”™è¯¯')); clearInterval(timer); setPreparing(false); return; }
                setStats(s.stats || {});
                setProgress({ scanned: s.scanned_files||0, matched: s.matched_files||0, copied: s.copied_files||0 });
                if (!s.running) {
                  clearInterval(timer);
                  const total = Object.values(s.stats || {}).reduce((sum, v) => sum + (v.copied||0), 0);
                  setStatus(`å®Œæˆï¼šå…±å¤åˆ¶ ${total} ä¸ªæ–‡ä»¶åˆ° lots/ ä¸‹ï¼Œç”¨æ—¶ ${s.elapsed_seconds}s`);
                  setPreparing(false);
                } else {
                  setStatus(`æ­£åœ¨ç­›é€‰å¹¶å¤åˆ¶... å·²æ‰«æ ${s.scanned_files}ï¼ŒåŒ¹é… ${s.matched_files}ï¼Œå¤åˆ¶ ${s.copied_files}`);
                }
              } catch (e) {
                clearInterval(timer);
                setStatus('å¤±è´¥ï¼š' + e.message);
                setPreparing(false);
              }
            }, 1000);
          } catch (e) {
            setStatus('å¤±è´¥ï¼š' + e.message);
            setPreparing(false);
          }
        };
        return (
          <div className="card">
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
              <h2 style={{margin:0}}>å‡†å¤‡ SUM æ–‡ä»¶</h2>
              <a href="#/" style={{color:'#2563eb',textDecoration:'none'}}>â† è¿”å›é—¨æˆ·</a>
            </div>
            <p className="comment">ç¬¬ä¸€æ­¥ï¼šè¾“å…¥å¤šä¸ª lot åï¼Œç‚¹å‡»â€œå¼€å§‹ç­›é€‰å¤åˆ¶â€ï¼Œä» SLT_Summary é€’å½’æŸ¥æ‰¾åŒ¹é…çš„ SUM æ–‡ä»¶å¹¶å¤åˆ¶åˆ° lots/lotNameã€‚</p>
            <label htmlFor="srcRoot">æºç›®å½•ï¼ˆå¯é€‰ï¼Œé»˜è®¤ UNC æˆ–ç¯å¢ƒå˜é‡ï¼‰</label>
            <div className="row" style={{marginBottom:8}}>
              <input id="srcRoot" type="text" value={sourceRoot} onChange={e=>setSourceRoot(e.target.value)} placeholder="\\\\172.33.10.11\\SLT_Summary" />
            </div>
            <label htmlFor="lotName">lot åï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰</label>
            <div className="row">
              <input id="lotName" type="text" value={inputVal} onChange={e=>setInputVal(e.target.value)} placeholder="ä¾‹å¦‚ï¼šsmx" />
              <button onClick={addLot}>æ·»åŠ </button>
            </div>
            {!!lots.length && (
              <div style={{marginTop:10}}>
                <div className="comment">å·²æ·»åŠ çš„ lotï¼š</div>
                {lots.map((v, i) => (
                  <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'6px 0'}}>
                    <span>â€¢ {v}</span>
                    <button className="secondary" onClick={()=>removeLot(i)}>åˆ é™¤</button>
                  </div>
                ))}
              </div>
            )}
            <div style={{display:'flex',gap:10,marginTop:10}}>
              <button onClick={startPrepare} disabled={preparing}>å¼€å§‹ç­›é€‰å¤åˆ¶</button>
              <a href="#/sum" style={{alignSelf:'center',color:'#2563eb',textDecoration:'none'}}>å‰å¾€ç”Ÿæˆ xlsx â†’</a>
            </div>
            <div className="status">{status}</div>
            {preparing && (
              <div className="comment">è¿›åº¦ï¼šå·²æ‰«æ {progress.scanned}ï½œåŒ¹é… {progress.matched}ï½œå¤åˆ¶ {progress.copied}</div>
            )}
            {stats && (
              <div style={{marginTop:10}}>
                <div className="comment">å¤åˆ¶ç»“æœï¼š</div>
                {Object.entries(stats).map(([lot, info]) => (
                  <div key={lot} className="comment">{lot} â†’ {info.copied} ä¸ªæ–‡ä»¶ï¼Œç›®æ ‡ï¼š{info.dest}</div>
                ))}
              </div>
            )}
          </div>
        );
      }

      // ä¸€ä½“åŒ–æµç¨‹ï¼šå…ˆå‡†å¤‡ï¼ˆç­›é€‰å¤åˆ¶ï¼‰ï¼Œå†æ±‡æ€»ç”Ÿæˆ xlsx
      function SumWizard() {
        const [sourceRoot, setSourceRoot] = useState('\\\\172.33.10.11\\SLT_Summary');
        const [inputVal, setInputVal] = useState('');
        const [lots, setLots] = useState([]);
        const [prepareStats, setPrepareStats] = useState(null);
        const [prepareStatus, setPrepareStatus] = useState('');
        const [preparing, setPreparing] = useState(false);
        const [prepareJobId, setPrepareJobId] = useState('');
        const [progress, setProgress] = useState({ scanned: 0, matched: 0, copied: 0 });
        const [lotsPath, setLotsPath] = useState('lots');
        const [runStatus, setRunStatus] = useState('');
        const [downloadUrl, setDownloadUrl] = useState('');
        const [step, setStep] = useState(1);
        // æ–°å¢ï¼šTpNameï¼ˆProgram IDï¼‰è¿‡æ»¤æ§åˆ¶
        const [enableTpFilter, setEnableTpFilter] = useState(false);
        const [tpName, setTpName] = useState('');

        const addLot = () => {
          const v = (inputVal || '').trim();
          if (!v) return;
          const exists = lots.some(x => x.toLowerCase() === v.toLowerCase());
          if (exists) { setPrepareStatus('è¯¥ lot å·²åœ¨åˆ—è¡¨ä¸­'); return; }
          setLots([...lots, v]);
          setInputVal('');
          setPrepareStatus('å·²æ·»åŠ ');
        };
        const removeLot = (idx) => {
          const next = lots.slice(); next.splice(idx,1); setLots(next);
        };
        const startPrepare = async () => {
          if (!lots.length) { setPrepareStatus('è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€ä¸ª lot å'); return; }
          if (preparing) return; // ç¦æ­¢äºŒæ¬¡ç‚¹å‡»
          setPreparing(true);
          setPrepareStatus('æ­£åœ¨ç­›é€‰å¹¶å¤åˆ¶...'); setPrepareStats(null); setRunStatus(''); setDownloadUrl('');
          try {
            const res = await fetch('/api/sum/prepare/start', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ lot_names: lots, source_root: sourceRoot })
            });
            const data = await res.json();
            if (!data.ok) { setPreparing(false); setPrepareStatus('å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯')); return; }
            setPrepareJobId(data.job_id);
            const timer = setInterval(async () => {
              try {
                const r = await fetch(`/api/sum/prepare/status?job=${encodeURIComponent(data.job_id)}`);
                const s = await r.json();
                if (!s.ok) { setPrepareStatus('å¤±è´¥ï¼š' + (s.error || 'æœªçŸ¥é”™è¯¯')); clearInterval(timer); setPreparing(false); return; }
                setPrepareStats(s.stats || {});
                setProgress({ scanned: s.scanned_files||0, matched: s.matched_files||0, copied: s.copied_files||0 });
                if (!s.running) {
                  clearInterval(timer);
                  const total = Object.values(s.stats || {}).reduce((sum, v) => sum + (v.copied||0), 0);
                  setPrepareStatus(`å®Œæˆï¼šå…±å¤åˆ¶ ${total} ä¸ªæ–‡ä»¶åˆ° lots/ ä¸‹ï¼Œç”¨æ—¶ ${s.elapsed_seconds}s`);
                  setLotsPath('lots');
                  setPreparing(false);
                } else {
                  setPrepareStatus(`æ­£åœ¨ç­›é€‰å¹¶å¤åˆ¶... å·²æ‰«æ ${s.scanned_files}ï¼ŒåŒ¹é… ${s.matched_files}ï¼Œå¤åˆ¶ ${s.copied_files}`);
                }
              } catch (e) {
                clearInterval(timer);
                setPrepareStatus('å¤±è´¥ï¼š' + e.message);
                setPreparing(false);
              }
            }, 1000);
          } catch (e) {
            setPrepareStatus('å¤±è´¥ï¼š' + e.message);
            setPreparing(false);
          }
        };
        const run = async () => {
          if (!lotsPath || !lotsPath.trim()) { setRunStatus('è¯·å…ˆå¡«å†™ lots ç›®å½•è·¯å¾„'); return; }
          setRunStatus('æ­£åœ¨ç”Ÿæˆ xlsx ...'); setDownloadUrl('');
          try {
            const payload = { lots_dir: lotsPath };
            if (enableTpFilter && (tpName || '').trim()) {
              payload.use_tp_filter = true;
              payload.tp_name = tpName.trim();
            } else {
              payload.use_tp_filter = false;
            }
            const res = await fetch('/api/sum/run', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.ok) {
              setRunStatus(`å·²åœ¨æ ¹ç›®å½•ä¸‹çš„ exports æ–‡ä»¶å¤¹ä¸‹æˆåŠŸç”Ÿæˆï¼š${data.filename}`);
              setDownloadUrl(data.download_url);
            } else {
              setRunStatus('ç”Ÿæˆå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
          } catch (e) {
            setRunStatus('ç”Ÿæˆå¤±è´¥ï¼š' + e.message);
          }
        };
        const clearAllLots = async () => {
          if (!lotsPath || !lotsPath.trim()) { setPrepareStatus('è¯·å…ˆå¡«å†™ lots ç›®å½•è·¯å¾„'); return; }
          setPrepareStatus('æ­£åœ¨æ¸…é™¤ lots ä¸‹çš„å­ç›®å½• ...'); setPrepareStats(null);
          try {
            const res = await fetch('/api/sum/clear', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ lots_dir: lotsPath })
            });
            const data = await res.json();
            if (data.ok) {
              const removedCount = (data.removed || []).length;
              setPrepareStatus(`æ¸…é™¤å®Œæˆï¼šç§»é™¤ ${removedCount} ä¸ª lot ç›®å½•ï¼ˆæ–‡ä»¶ ${data.deleted_files}ï¼‰`);
            } else {
              setPrepareStatus('æ¸…é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
          } catch (e) {
            setPrepareStatus('æ¸…é™¤å¤±è´¥ï¼š' + e.message);
          }
        };
        const clearLots = async () => {
          if (!lotsPath || !lotsPath.trim()) { setRunStatus('è¯·å…ˆå¡«å†™ lots ç›®å½•è·¯å¾„'); return; }
          setRunStatus('æ­£åœ¨æ¸…é™¤ lots ä¸‹çš„å­æ–‡ä»¶å¤¹ ...'); setDownloadUrl('');
          try {
            const res = await fetch('/api/sum/clear', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ lots_dir: lotsPath })
            });
            const data = await res.json();
            if (data.ok) {
              const removedCount = (data.removed || []).length;
              setRunStatus(`æ¸…é™¤å®Œæˆï¼šç§»é™¤ ${removedCount} ä¸ª lot ç›®å½•ï¼ˆæ–‡ä»¶ ${data.deleted_files}ï¼‰`);
              setPrepareStats(null);
              setPrepareStatus('');
              setDownloadUrl('');
            } else {
              setRunStatus('æ¸…é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
          } catch (e) {
            setRunStatus('æ¸…é™¤å¤±è´¥ï¼š' + e.message);
          }
        };
        // è®¡ç®—æ˜¯å¦å¯ä»¥ä¸‹ä¸€æ­¥
        const canNext = (() => {
          if (!prepareStats) return false;
          try {
            const total = Object.values(prepareStats).reduce((s, v) => s + (v.copied||0), 0);
            return total > 0;
          } catch { return false; }
        })();

        return (
          <div className="card">
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
              <h2 style={{margin:0}}>SUM ä¸€ä½“åŒ–æµç¨‹</h2>
              <a href="#/" style={{color:'#2563eb',textDecoration:'none'}}>â† è¿”å›é—¨æˆ·</a>
            </div>
            <p className="comment">å…ˆè¾“å…¥å¤šä¸ª lot åå¹¶ä»æºç›®å½•é€’å½’ç­›é€‰å¤åˆ¶åˆ° lots/ï¼Œå†ç”Ÿæˆ xlsxã€‚</p>
            {step === 1 && (
              <div>
                <h3 style={{margin:'16px 0 8px'}}>æ­¥éª¤ä¸€ï¼šå‡†å¤‡ SUM æ–‡ä»¶</h3>
                <label htmlFor="srcRoot">æºç›®å½•ï¼ˆå¯é€‰ï¼Œé»˜è®¤ UNC æˆ–ç¯å¢ƒå˜é‡ï¼‰</label>
                <div className="row" style={{marginBottom:8}}>
                  <input id="srcRoot" type="text" value={sourceRoot} onChange={e=>setSourceRoot(e.target.value)} placeholder="\\\\172.33.10.11\\SLT_Summary" />
                </div>
                <label htmlFor="lotName">lot åï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰</label>
                <div className="row">
                  <input id="lotName" type="text" value={inputVal} onChange={e=>setInputVal(e.target.value)} placeholder="ä¾‹å¦‚ï¼šsmx" />
                  <button onClick={addLot}>æ·»åŠ </button>
                </div>
                {!!lots.length && (
                  <div style={{marginTop:10}}>
                    <div className="comment">å·²æ·»åŠ çš„ lotï¼š</div>
                    {lots.map((v, i) => (
                      <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'6px 0'}}>
                        <span>â€¢ {v}</span>
                        <button className="secondary" onClick={()=>removeLot(i)}>åˆ é™¤</button>
                      </div>
                    ))}
                  </div>
                )}
                <div className="row" style={{marginTop:12}}>
                  <button onClick={clearAllLots} className="secondary" title="åˆ é™¤ lots ä¸‹æ‰€æœ‰å­ç›®å½•åŠå…¶å†…å®¹">æ¸…é™¤ lots</button>
                </div>
                <div style={{display:'flex',gap:10,marginTop:10}}>
                  <button onClick={startPrepare} disabled={preparing}>å¼€å§‹ç­›é€‰å¤åˆ¶</button>
                  <button onClick={()=>setStep(2)} disabled={!canNext || preparing}>ä¸‹ä¸€æ­¥</button>
                </div>
                <div className="status">{prepareStatus}</div>
                {preparing && (
                  <div className="comment">è¿›åº¦ï¼šå·²æ‰«æ {progress.scanned}ï½œåŒ¹é… {progress.matched}ï½œå¤åˆ¶ {progress.copied}</div>
                )}
                {prepareStats && (
                  <div style={{marginTop:10}}>
                    <div className="comment">å¤åˆ¶ç»“æœï¼š</div>
                    {Object.entries(prepareStats).map(([lot, info]) => (
                      <div key={lot} className="comment">{lot} â†’ {info.copied} ä¸ªæ–‡ä»¶ï¼Œç›®æ ‡ï¼š{info.dest}</div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {step === 2 && (
              <div>
                <h3 style={{margin:'16px 0 8px'}}>æ­¥éª¤äºŒï¼šå¯é€‰çš„ TpName è¿‡æ»¤</h3>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                  <input id="tpFilterEnable" type="checkbox" checked={enableTpFilter} onChange={e=>setEnableTpFilter(e.target.checked)} />
                  <label htmlFor="tpFilterEnable" style={{margin:0}}>æŒ‰ Program IDï¼ˆTpNameï¼‰è¿‡æ»¤</label>
                </div>
                <div className="row" style={{marginTop:8}}>
                  <input id="tpName" type="text" disabled={!enableTpFilter} value={tpName} onChange={e=>setTpName(e.target.value)} placeholder="ä¾‹å¦‚ï¼šTP-ABC-001" />
                </div>
                <div className="comment" style={{marginTop:8}}>
                  å¯ç”¨è¿‡æ»¤åï¼Œä»…ç»Ÿè®¡ Program ID ä¸è¾“å…¥ TpName ç²¾ç¡®åŒ¹é…ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰çš„ SUM æ–‡ä»¶ï¼›ä¸åŒ¹é…çš„æ–‡ä»¶å°†è¢«è·³è¿‡ã€‚
                </div>
                <div style={{display:'flex',gap:10,marginTop:10}}>
                  <button className="secondary" onClick={()=>setStep(1)}>ä¸Šä¸€æ­¥</button>
                  <button onClick={()=>setStep(3)}>ä¸‹ä¸€æ­¥</button>
                </div>
              </div>
            )}

            {step === 3 && (
              <div>
                <h3 style={{margin:'16px 0 8px'}}>æ­¥éª¤ä¸‰ï¼šç”Ÿæˆ xlsx</h3>
                <label htmlFor="lotsPath">lots è·¯å¾„</label>
                <div className="row">
                  <input id="lotsPath" type="text" value={lotsPath} onChange={e=>setLotsPath(e.target.value)} placeholder="lots" />
                  <button onClick={()=>setLotsPath('lots')} className="secondary">é»˜è®¤</button>
                  <button onClick={clearLots} className="secondary" title="åˆ é™¤ lots ä¸‹æ‰€æœ‰å­ç›®å½•åŠå…¶å†…å®¹">æ¸…é™¤</button>
                  <button onClick={run}>ç”Ÿæˆ xlsx</button>
                </div>
                <div style={{display:'flex',gap:10,marginTop:10}}>
                  <button className="secondary" onClick={()=>setStep(2)}>ä¸Šä¸€æ­¥</button>
                </div>
                <div className="status">{runStatus}</div>
                {downloadUrl && <div className="link"><a href={downloadUrl} target="_blank" rel="noreferrer">ğŸ¤”æ‰¾ä¸åˆ°ï¼Ÿå¦å­˜ä¸º</a></div>}
              </div>
            )}
          </div>
        );
      }

      // ç®€æ˜“å“ˆå¸Œè·¯ç”±
      function App() {
        const [route, setRoute] = useState(window.location.hash || '#/');
        useEffect(() => {
          const onHash = () => setRoute(window.location.hash || '#/');
          window.addEventListener('hashchange', onHash);
          return () => window.removeEventListener('hashchange', onHash);
        }, []);
        if (route.startsWith('#/prepare')) return <PrepareLots/>;
        if (route.startsWith('#/sum-wizard')) return <SumWizard/>;
        if (route.startsWith('#/sum')) return <SumTool/>;
        return <Portal/>;
      }

      ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
    </script>
  </body>
  </html>
